<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MapReduce | Think More</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/blog/icon.png">
    <meta name="description" content="Think More, Code Less">
    
    <link rel="preload" href="/blog/assets/css/0.styles.20ba6ef9.css" as="style"><link rel="preload" href="/blog/assets/js/app.81f5ed6d.js" as="script"><link rel="preload" href="/blog/assets/js/2.20a6e160.js" as="script"><link rel="preload" href="/blog/assets/js/17.9453620a.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.f3a2a13e.js"><link rel="prefetch" href="/blog/assets/js/11.f0a24899.js"><link rel="prefetch" href="/blog/assets/js/12.cfd701a0.js"><link rel="prefetch" href="/blog/assets/js/13.440aafe2.js"><link rel="prefetch" href="/blog/assets/js/14.b4252a51.js"><link rel="prefetch" href="/blog/assets/js/15.a2d666df.js"><link rel="prefetch" href="/blog/assets/js/16.ca1e9625.js"><link rel="prefetch" href="/blog/assets/js/18.131c7f0a.js"><link rel="prefetch" href="/blog/assets/js/19.c52e21a5.js"><link rel="prefetch" href="/blog/assets/js/20.3b257f00.js"><link rel="prefetch" href="/blog/assets/js/21.b5645340.js"><link rel="prefetch" href="/blog/assets/js/22.c68a7dcd.js"><link rel="prefetch" href="/blog/assets/js/3.e02fe533.js"><link rel="prefetch" href="/blog/assets/js/4.67734695.js"><link rel="prefetch" href="/blog/assets/js/5.ed708879.js"><link rel="prefetch" href="/blog/assets/js/6.ac9801b0.js"><link rel="prefetch" href="/blog/assets/js/7.22221c05.js"><link rel="prefetch" href="/blog/assets/js/8.67a03ccf.js"><link rel="prefetch" href="/blog/assets/js/9.35931d2a.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.20ba6ef9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">Think More</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/blog/pages/interview/" class="nav-link">
  Interview
</a></div><div class="nav-item"><a href="/blog/pages/leetcode/" class="nav-link">
  Leetcode
</a></div><div class="nav-item"><a href="/blog/pages/mit6.824/" class="nav-link router-link-active">
  MIT6.824
</a></div><div class="nav-item"><a href="https://github.com/RickyWei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/blog/pages/interview/" class="nav-link">
  Interview
</a></div><div class="nav-item"><a href="/blog/pages/leetcode/" class="nav-link">
  Leetcode
</a></div><div class="nav-item"><a href="/blog/pages/mit6.824/" class="nav-link router-link-active">
  MIT6.824
</a></div><div class="nav-item"><a href="https://github.com/RickyWei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>mit6.824</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/pages/mit6.824/01mapreduce.html" aria-current="page" class="active sidebar-link">MapReduce</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/pages/mit6.824/01mapreduce.html#abstract" class="sidebar-link">Abstract</a></li><li class="sidebar-sub-header"><a href="/blog/pages/mit6.824/01mapreduce.html#programming-model" class="sidebar-link">Programming Model</a></li><li class="sidebar-sub-header"><a href="/blog/pages/mit6.824/01mapreduce.html#implementation" class="sidebar-link">Implementation</a></li><li class="sidebar-sub-header"><a href="/blog/pages/mit6.824/01mapreduce.html#master-data-structures" class="sidebar-link">Master Data Structures</a></li><li class="sidebar-sub-header"><a href="/blog/pages/mit6.824/01mapreduce.html#fault-tolerance" class="sidebar-link">Fault Tolerance</a></li><li class="sidebar-sub-header"><a href="/blog/pages/mit6.824/01mapreduce.html#locality" class="sidebar-link">Locality</a></li><li class="sidebar-sub-header"><a href="/blog/pages/mit6.824/01mapreduce.html#task-granularity" class="sidebar-link">Task Granularity</a></li><li class="sidebar-sub-header"><a href="/blog/pages/mit6.824/01mapreduce.html#backup-tasks" class="sidebar-link">Backup Tasks</a></li><li class="sidebar-sub-header"><a href="/blog/pages/mit6.824/01mapreduce.html#refinements" class="sidebar-link">Refinements</a></li></ul></li><li><a href="/blog/pages/mit6.824/" aria-current="page" class="sidebar-link">/pages/mit6.824/</a></li></ul></section></li></ul> </aside> <a href="https://github.com/RickyWei" target="_blank" rel="noopener" class="github-link active"><p class="nes-balloon from-right">Follow me<br>on GitHub</p> <i class="nes-octocat"></i></a> <main class="page"> <div class="theme-default-content content__default" style="font-family:consolas;"><h1 id="mapreduce"><a href="#mapreduce" class="header-anchor">#</a> MapReduce</h1> <h2 id="abstract"><a href="#abstract" class="header-anchor">#</a> Abstract</h2> <ol><li>MapReduce是一种处理大数据的编程模型</li></ol> <h2 id="programming-model"><a href="#programming-model" class="header-anchor">#</a> Programming Model</h2> <ol><li>Map
<ol><li>map(k1,v1) -&gt; list(k2,v2)</li> <li>输入：key/value 键值对</li> <li>输出：key/value 键值对，即一些中间结果</li></ol></li> <li>Reduce
<ol><li>reduce(k2,list(v2)) -&gt; list(v2)</li> <li>输入：key/value 键值对，即map产生的中间结果</li> <li>输出：最终结果</li></ol></li></ol> <h3 id="examples"><a href="#examples" class="header-anchor">#</a> Examples</h3> <h4 id="word-count"><a href="#word-count" class="header-anchor">#</a> Word Count</h4> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code><span class="token function">map</span><span class="token punctuation">(</span>String key<span class="token punctuation">,</span> String value<span class="token punctuation">)</span><span class="token operator">:</span>
    <span class="token comment">// key: document name</span>
    <span class="token comment">// value: document contents</span>
    <span class="token keyword">for</span> each word w in value<span class="token operator">:</span>
        <span class="token function">EmitIntermediate</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">reduce</span><span class="token punctuation">(</span>String key<span class="token punctuation">,</span> Iterator values<span class="token punctuation">)</span><span class="token operator">:</span>
    <span class="token comment">// key: a word</span>
    <span class="token comment">// values: a list of counts</span>
    <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> each v in values<span class="token operator">:</span>
        result <span class="token operator">+=</span> <span class="token function">ParseInt</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Emit</span><span class="token punctuation">(</span><span class="token function">AsString</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ol><li>map为每个单词产生一个中间结果 word/1，1为单词出现的频率</li> <li>reduce合并一个单词总共出现的频率</li></ol> <h4 id="distributed-grep"><a href="#distributed-grep" class="header-anchor">#</a> Distributed Grep</h4> <ol><li>map(document name, document content) -&gt; list(matched line, 1)</li> <li>reduce(matched line, list(1)) -&gt; list(matched line)</li></ol> <h4 id="inverted-index"><a href="#inverted-index" class="header-anchor">#</a> Inverted Index</h4> <ol><li>map(document id, document content) -&gt; list(word, document id)</li> <li>reduce(word, list(document id)) -&gt; (word, list(document id))</li></ol> <h2 id="implementation"><a href="#implementation" class="header-anchor">#</a> Implementation</h2> <h3 id="execution-overview"><a href="#execution-overview" class="header-anchor">#</a> Execution Overview</h3> <p>MapReduce被调用时将执行以下流程</p> <p><img src="https://raw.githubusercontent.com/RickyWei/blog/img/img/20210301232911.png" alt="mapreduce overview"></p> <ol><li>MapReduce库首先将输入文件分割成 M 块（每块通常16-64MB，此步骤可被多台机器并行执行）；在集群中开启MR程序</li> <li>其中一个为Master其余为Workers；Master将M个Map任务和R个Reduce任务分配给空闲的Worker</li> <li>被分配Map任务的Worker读取对应的输入块；解析出每个key/value对并送入用户定义的Map()函数；Map()产生的中间kv结果存放在内存中</li> <li>每隔一定时间Partition()函数（eg. <code>hash(key)%R</code>）将内存中的这些中间kv结果分到R个区域并写入磁盘；文件位置将会传给Master，Master再将其转发给Reduce Worker（增量式的推送）</li> <li>当Reduce Worker被Master通知时，它将通过RPC从Map Wroker读取中间结果；当Reduce Wroker读取完所有中间结果后，它将按key排序，所以具有相同key的kv对被放在了一起；</li> <li>Reduce Worker遍历被排序的中间结果，将每个不同的key和其对应的所有values传入用户定义的Reduce()函数；最终结果被追加到该partition对用的文件中</li> <li>当所有Map和Reduce完成时，MapReduce调用返回</li></ol> <h2 id="master-data-structures"><a href="#master-data-structures" class="header-anchor">#</a> Master Data Structures</h2> <ol><li>存储每个Map和Reduce任务的状态（等待（idle），正在执行，完成）；对非等待的任务存储其Worker ID</li> <li>存储每个完成的Map任务的中间结果的位置</li></ol> <h2 id="fault-tolerance"><a href="#fault-tolerance" class="header-anchor">#</a> Fault Tolerance</h2> <h3 id="worker-failure"><a href="#worker-failure" class="header-anchor">#</a> Worker Failure</h3> <ol><li>Master会定期Ping Worker，当一定时间未收到回复认为Worker故障</li> <li>所有分配到该Worker的Map/Reduce任务被标为idle状态并等待reschedule到其他Worker</li> <li>该Worker上已结束的Map任务会被重新执行，因为中间结果保存在local disk；Reduce不会被重新执行，因为结果保存在global file system</li> <li>当Map任务因为故障从A迁移到B，对应的Reduce任务会被通知，如果该Reduce任务还未从A读取全部数据便会从B读取</li></ol> <h3 id="master-failure"><a href="#master-failure" class="header-anchor">#</a> Master Failure</h3> <ol><li>一种方法是Master可以实现定期将自己的状态写入checkpoint，新的Master通过checkpoint启动</li></ol> <h2 id="locality"><a href="#locality" class="header-anchor">#</a> Locality</h2> <ol><li>网络带宽是有限制的</li> <li>通常一个数据块在GFS上会有3份拷贝，Master在通过这些位置信息尝试安排Map任务在具有该数据副本的机器上；如果不行则尝试安排在离数据副本距离较近的机器上（如在同一个局域网内）</li></ol> <h2 id="task-granularity"><a href="#task-granularity" class="header-anchor">#</a> Task Granularity</h2> <ol><li>理想情况下，M和R的数量应远大于机器的数量；这样可以提高动态的负载均衡；加速故障恢复</li> <li>实际中，Master需要做<mjx-container jax="CHTML" class="MathJax"><mjx-math class=" MJX-TEX"><mjx-mi class="mjx-i"><mjx-c c="O"></mjx-c></mjx-mi><mjx-mo class="mjx-n"><mjx-c c="("></mjx-c></mjx-mo><mjx-mi class="mjx-i"><mjx-c c="M"></mjx-c></mjx-mi><mjx-mo space="3" class="mjx-n"><mjx-c c="+"></mjx-c></mjx-mo><mjx-mi space="3" class="mjx-i"><mjx-c c="R"></mjx-c></mjx-mi><mjx-mo class="mjx-n"><mjx-c c=")"></mjx-c></mjx-mo></mjx-math></mjx-container>次的决定并在内存中保存<mjx-container jax="CHTML" class="MathJax"><mjx-math class=" MJX-TEX"><mjx-mi class="mjx-i"><mjx-c c="O"></mjx-c></mjx-mi><mjx-mo class="mjx-n"><mjx-c c="("></mjx-c></mjx-mo><mjx-mi class="mjx-i"><mjx-c c="M"></mjx-c></mjx-mi><mjx-mo space="3" class="mjx-n"><mjx-c c="2217"></mjx-c></mjx-mo><mjx-mi space="3" class="mjx-i"><mjx-c c="R"></mjx-c></mjx-mi><mjx-mo class="mjx-n"><mjx-c c=")"></mjx-c></mjx-mo></mjx-math></mjx-container>的信息</li> <li>为了利用局部性，选择的M将使得被分割的问价大小介于16-64MB；R通常为机器数的一个小倍数（eg. machines=2000, M=200000, R=5000）</li></ol> <h2 id="backup-tasks"><a href="#backup-tasks" class="header-anchor">#</a> Backup Tasks</h2> <ol><li>MapReduce的总执行时间通常因为短板（如某个机器磁盘太慢）变得更长，如果该机器同时被别的MR调用分配任务，因为CPU或IO竞争会更慢</li> <li>替补任务是当一个MR调用接近完成时，Master为剩余正在执行的任务再分配一个机器，当任意一个机器结束时将该任务标记为完成</li></ol> <h2 id="refinements"><a href="#refinements" class="header-anchor">#</a> Refinements</h2> <h3 id="partitioning-function"><a href="#partitioning-function" class="header-anchor">#</a> Partitioning Function</h3> <ol><li>默认情况下，我们使用<code>hash(key) Mod R</code>这种partitioning函数，因为它可以产生较为均衡的R个分区</li> <li>某些情况下，我们希望一些特定的partition函数，比如将一个host的所有URL分在一起<code>hash(Hostname(urlkey)) mod R</code></li></ol> <h3 id="ordering-guarantees"><a href="#ordering-guarantees" class="header-anchor">#</a> Ordering Guarantees</h3> <ol><li>MR保证再一个partition中，k/v对按key值排序</li> <li>有序性方便后续可能的查找等操作</li></ol> <h3 id="combiner-function"><a href="#combiner-function" class="header-anchor">#</a> Combiner Function</h3> <ol><li>一些情况下，用户定义的Reduce方法是可结合可交换的（associative and commutative）</li> <li>我们可以在Map过程中执行Combiner Function（eg. 在word count中，Map可能会输出多个&lt;the, 1&gt;的键值对，我们可以执行Combiner Function做本地合并后再发送到网络中）</li> <li>Combiner Function和Reduce Function基本相同，区别是输出不同（前者输出将要发送到Reduce的中间结果，后者为最终输出）</li></ol> <h3 id="input-and-output-types"><a href="#input-and-output-types" class="header-anchor">#</a> Input and Output Types</h3> <ol><li>MapReduce library提供了多种Input/Output类型（eg. &quot;text&quot;模式将每一行作为key/value对，key是改行在文件中的偏移量，value是该行的内容）</li> <li>用户通过实现<code>reader</code>接口可以定义自己的Input/Output类型；<code>reader</code>不仅可以从文件中读，也可以从内存或数据库等中读取</li></ol> <h3 id="side-effects"><a href="#side-effects" class="header-anchor">#</a> Side-effects</h3> <ol><li>某些情况下，输出一些额外的辅助文件是很有用的</li> <li>但是用户需要自己保证这种side-effects的原子性和幂等性（eg. 一个方法是先输出到一个临时文件，最后再原子的重命名）</li></ol> <h3 id="skipping-bad-records"><a href="#skipping-bad-records" class="header-anchor">#</a> Skipping Bad Records</h3> <ol><li>有时Map或Reduce函数在一些record中存在bug，此时可以选择跳过这些record（因为有时bug因为其他第三方库产生或者忽略一些记录不太影响结果）</li> <li>MR提供这中可跳过record的mode；每个worker会安装一个signal handler，每当某个record引发错误时，signal handler会发送一个&quot;last gasp&quot; UDP报文给master，当master收到产生于一个record的多个错误，便认为该recod在下次被执行时应该被跳过</li></ol> <h3 id="local-execution"><a href="#local-execution" class="header-anchor">#</a> Local Execution</h3> <ol><li>为了更好的debug，MR提供了一个库可以顺序的在本机执行所有MR操作</li></ol> <h3 id="status-information"><a href="#status-information" class="header-anchor">#</a> Status Information</h3> <ol><li>Master会开启一个内部的HTTP server，该server提供了MR的各种信息</li></ol> <h3 id="counters"><a href="#counters" class="header-anchor">#</a> Counters</h3> <div class="language-cpp line-numbers-mode"><pre class="language-cpp"><code>Counter <span class="token operator">*</span>uppercase<span class="token punctuation">;</span>
uppercase <span class="token operator">=</span> <span class="token function">GetCounter</span><span class="token punctuation">(</span><span class="token string">&quot;uppercase&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">map</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> String contents<span class="token punctuation">)</span><span class="token operator">:</span> 
    foreach word w in contents<span class="token operator">:</span> 
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IsCapitalized</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">:</span> 
            uppercase<span class="token operator">-&gt;</span><span class="token function">Increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">EmitIntermediate</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol><li>MR提供统计某个事件出现次数的特性；用户可以通过创建一个counter对象并在Map/Reduce函数中增加它（eg. 统计有多少单词被处理）</li> <li>每个Worker中counter的值被放入在对Master的心跳检测ping的回应中</li> <li>Master会处理每个counter的值（防止值被重复统计等，因为任务可能因为故障而被重新执行）并在MR结束时返回给用户</li></ol> <blockquote><p>MapReduce: Simplified Data Processing on Large Clusters</p></blockquote></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">3/7/2021, 3:51:25 AM</span></div></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/blog/pages/mit6.824/" class="router-link-active">
        /pages/mit6.824/
      </a>
      &gt;
    </span></p></div> </main> <button type="button" class="nes-btn is-success scroll-btn"><span>&lt;</span></button></div><div class="global-ui"><div></div></div></div>
    <script src="/blog/assets/js/app.81f5ed6d.js" defer></script><script src="/blog/assets/js/2.20a6e160.js" defer></script><script src="/blog/assets/js/17.9453620a.js" defer></script>
  </body>
</html>
